{% extends "base.html" %}

{% block title %}Matcha{% endblock %}

{% block content %}
    {{ block.super }}
    <section class="content">
        {% include "cards.html" %}
    </section>
    <nav style="bottom:10px;z-index:10;position:fixed;left:45%;" aria-label="...">
      <ul class="pagination" style="">
        <li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1">Previous</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page=1">1</a>
        </li>
        <li class="page-item active">
          <a class="page-link" href="?page=2">2 <span class="sr-only">(current)</span></a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page=3">3</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav>
{% endblock %}

{% block body_scripts %}
    {{ block.super }}
    <script>
    function pagination(c, m) {
        var current = c,
            last = m,
            delta = 2,
            left = current - delta,
            right = current + delta + 1,
            range = [],
            rangeWithDots = [],
            l;
        for (let i = 1; i <= last; i++) {
            if (i == 1 || i == last || i >= left && i < right) {
                range.push(i);
            }
        }
        for (let i of range) {
            if (l) {
                if (i - l === 2) {
                    rangeWithDots.push(l + 1);
                } else if (i - l !== 1) {
                    rangeWithDots.push('...');
                }
            }
            rangeWithDots.push(i);
            l = i;
        }
        return rangeWithDots;
    }
    </script>
    <script>
        function check_line_clamp() {
            document.querySelectorAll("#history").forEach(el => {
                if (el.scrollHeight === el.clientHeight) {
                    el.parentNode.querySelector("button").style.display = "none";
                } else {
                    el.parentNode.querySelector("button").style.display = "block";
                }
            })
        }
        check_line_clamp();
        window.onresize = function(e) {
            check_line_clamp();
        }
    </script>
    <script>
        document.querySelectorAll(".user-profile-short").forEach(el => {
            connect = el.querySelector("#connection .connect-date");
            _date = connect.textContent;
            if (_date !== "online" && _date !== "offline") {
                _date = moment(_date, "MMDDYYYY hh:mm:ss").fromNow();
                _date = _date === "Invalid date" ? "offline" : _date;
                connect.textContent = _date;
            }
        });
    </script>
    {% if global_user.id %}
    <script>
        let user_ids = [];
        {% for user in users %}
            user_ids.push({{ user.id }});
        {% endfor %}
        csrftoken = getCookie('csrftoken');
        for (let i = 0; i < {{ users|length }}; i++) {
            document.getElementById("act-like-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_connects/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": user_ids[i],
                            "type": 'плюс'
                        })
                    });
                }
            });
            document.getElementById("act-dislike-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_connects/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": user_ids[i],
                            "type": 'минус'
                        })
                    });
                }
            });
            document.getElementById("btn-report-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_fakes/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": user_ids[i]
                        })
                    });
                }
            });
            document.getElementById("btn-block-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_blacklists/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": user_ids[i]
                        })
                    });
                }
            });
        }
    </script>
    {% endif %}
{% endblock %}

</html>
