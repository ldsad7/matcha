{% extends "base.html" %}

{% block title %}Поиск{% endblock %}

{% load static %}



{% block content %}
    {{ block.super }}
    
    <script>
        // TODO: Добавлять кнопки действий только к тем пользователям, которые "подходят" global_user
        document.addEventListener("click", (e) => {
            if (!(e.target.id.startsWith("btn-report") || e.target.id.startsWith("btn-block") || e.target.id === "more-actions-btn")) {
                document.querySelectorAll(".buttons").forEach(el => {el.classList.remove("visible")});
            }
        });
        const focus_actions = (e) => e.target.parentNode.querySelector('.buttons').classList.toggle('visible');
        function check_actions(e, elem) {
            let targ_id = e.target.id;
            if (targ_id.startsWith('act-like-') || targ_id.startsWith('act-dislike-')) {
                if (targ_id.startsWith('act-like-')) {
                    elem.classList.add("animate__backOutRight");
                } else {
                    elem.classList.add("animate__backOutLeft");
                }
                setTimeout(() => {elem.remove()}, 600);
            }
        }
    </script>
    <section class="content">
        <div class="center">
            <div class="search-area">
                <input type="text" placeholder="Поиск...">
                <input type="checkbox" name="" id="search-toggle-check" style="display: none;" onchange="document.querySelector('.search-data').classList.toggle('display-flex'); document.querySelector('.search-toggle').classList.toggle('active')">
                <label for="search-toggle-check" class="search-toggle">
                    <span></span>
                </label>
            </div>
            <div class="search-data">
                <div class="age-gap">
                    <div class="age-gap-title">Возраст</div>
                    <span>От:</span>
                    <input type="number" name="" id="low_age" min="18" max="110" value="18">
                    <span>До:</span>
                    <input type="number" name="" id="high_age" min="14" max="110" value="110">
                </div>
                <div class="rating-gap">
                    <div class="rating-gap-title">Рейтинг</div>
                    <span>От:</span>
                    <input type="number" name="" id="low_rating" min="0" max="110" value="0">
                    <span>До:</span>
                    <input type="number" name="" id="high_rating" min="0" max="9999" value="0">
                </div>
                <div class="location">
                    <div class="location-gap-title">Местоположение:</div>
                    <input type="text" id="selectLocation" list="locat" placeholder="Поиск..." oninput="changeDatalist(this);"  autocomplete="off">
                    <datalist id="locat">
                        <option value="Москва"></option>
                        <option value="Москва и МО"></option>
                        <option value="Московская Область"></option>
                    </datalist>
                </div>
                <div class="interests">
                    <div class="rating-gap-title">Интересы:</div>
                    <div id="tags" class="search-tags"></div>
                </div>
            </div>
            <button id="search_button">Search</button>
        </div>
    </section>
{% endblock %}

{% block body_scripts %}
    {{ block.super }}
    <script>
        var new_tag_edited = false;
    
        function submitTag(el) {
            let input = el.querySelector("input");
            try {
                var data = input.value.trim();
            } catch (error) {
                return;
            }
            if (!data) {
                el.remove();
            }
            input.remove();
            el.classList.remove("active-tag");
            el.classList.remove("new-tag");
            if (new_tag_edited) {
                let del_btn = document.createElement("div");
                del_btn.classList.add("del_btn");
                el.appendChild(del_btn);
                tagListener(el);
                createNewTag();
                new_tag_edited = false;
            }
            el.querySelector("span").innerHTML = "#" + data;
        }
    
        function createNewTag() {
            let new_tag = document.createElement("div");
            let span = document.createElement("span");
            let tags_area = document.getElementById("tags");
    
            span.innerHTML = "# ";
            new_tag.classList.add("tag");
            new_tag.classList.add("new-tag");
            new_tag.appendChild(span);
            new_tag.appendChild(document.createElement("input"));
            tags_area.appendChild(new_tag);
            tagListener(new_tag);
            new_tag.querySelector("input").focus();
        }
    
        function tagListener(el) {
            el.addEventListener("click", function(e) {
                if (!el.classList.contains("active-tag") && !el.classList.contains("new-tag")) {
                    let active = document.querySelector(".active-tag");
                    if (active) {
                        submitTag(active);
                    }
                    el.classList.add("active-tag");
                    let span = el.querySelector("span");
                    let data = span.innerHTML.split("#")[1];
                    span.innerHTML = "# ";
                    let input = document.createElement("input");
                    input.setAttribute("value", data);
                    el.appendChild(input);
                }
            });
            el.addEventListener("input", function(e) {
                if (el.classList.contains("new-tag")) {
                    new_tag_edited = true;
                }
                if (el.classList.contains("new-tag") && el.querySelector("input").value == "") {
                    new_tag_edited = false;
                }
                if (e.data === " ") {
                    submitTag(el);
                }
            });
            el.addEventListener("keypress", function(e) {
                let code = e.keyCode || e.which;
                if (code === 13) {
                    if ((document.querySelector(".search-tags .new-tag") && document.querySelector(".new-tag input").value) || el.classList.contains("active-tag"))
                        submitTag(el);
                }
            });
            try {
                el.querySelector(".del_btn").addEventListener("click", function(e) {
                    el.remove();
                });
            } catch {
            }
        }
    
        function editTag() {
            document.addEventListener("click", function(e) {
                let active_tag = document.querySelector(".active-tag");
                if (active_tag) {
                    if (!(e.target == active_tag || active_tag.contains(e.target))) {
                        submitTag(active_tag);
                    }
                }
            });
            document.querySelectorAll(".interests .tag").forEach(el => {
                tagListener(el);
            });
        }
    
        var tags = {
            edit: function() {
                document.querySelectorAll(".search-tags .tag").forEach(el => {
                    let del_btn = document.createElement("div");
                    del_btn.classList.add("del_btn");
                    el.appendChild(del_btn);
                });
                // change_tag_btn.innerHTML = "&#10004;";
                createNewTag();
                editTag();
                // change_tag = true;
            },
            submit: function() {
                document.querySelectorAll(".search-tags .tag").forEach(el => {
                    try {
                        el.querySelector(".search-tags .del_btn").remove();
                    } catch (error) {
                    }
                });
                document.querySelector(".search-tags .new-tag").remove();
            }
        }
        tags.edit();
    </script>
    <script>
        document.getElementById("search_button").addEventListener("click", function(e) {
            csrftoken = getCookie('csrftoken');
            var tag_names = [];
            let tag_tags = $(".search-data .tag span");
            for (let tag_tag of tag_tags)
            {
                let text = tag_tag.textContent.trim().replace('#', '');
                if (text)
                    tag_names.push(text);
            }

            $.ajax({
                headers: {
                    'Content-Type' : 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrftoken
                },
                url: "/api/v1/users/",
                type: "GET",
                data: "age=" + $("#low_age").val() + ":" + $("#high_age").val() + "&rating=" + $("#low_rating").val() + ":" + $("#high_rating").val() + "&location=" + $("#selectLocation").val() + "&tags=" + tag_names.join(','),
                success: function(data) {
                    $("[data_id='result']").remove();
                    let i = 0;
                    var stackCall = [];
                    let html_str = '<div class="center" data_id="result">';
                    for (let user of data)
                    {
                        html_str += `
                        <section style="margin-left: 0" class="user-profile user-profile-short animate__animated" onclick="check_actions(event, this);">
                            {% if global_user.is_authenticated %}
                                <div id="more-actions">
                                    <button id="more-actions-btn" onclick="focus_actions(event)"></button>
                                    <span id="more-actions-span"></span>
                                    <div class="buttons">
                                        <button id="btn-report-${i}">report user</button>
                                        <button id="btn-block-${i}">block user</button>
                                    </div>
                                </div>
                            {% endif %}
                            <figure>
                                <div>`;
                        if (user.photos.length > 0)
                            html_str += `<img src="${user.photos[0].image}" alt="photo of a man">`;
                        else
                            html_str += '<img src="/static/img/default.png" alt="default profile picture">';
                        html_str += `
                            </div>
                            <div class="not-here-pls" id="del-avatar" style="display: none;">
                                <span class="not-here-pls">&#10008;</span>
                            </div>
                            <div id="connection"><span class="`
                            if (user.last_login != 'online') {
                                html_str += `red`;
                            }
                            html_str += `"></span><span class="connect-date">`;
                            if (user.last_login == 'offline' || user.last_login == 'online') {
                                html_str += user.last_login;
                            } else {
                                html_str += moment(new Date(user.last_login)).fromNow();
                            }
                        html_str += `</span></div>
                            </figure>
                            <section class="user-data">
                                <div id="username"><span>${user.username}</span></div>
                                <div id="name">
                                    <span>${user.first_name} ${user.last_name}</span>
                                </div>
                                <div id="rating">Рейтинг: <span>${user.rating}&#9733;</span></div>
                                <div>`
                            if (user.info) {
                                html_str += `<button id="show-more">показать полностью</button>
                                    <div id="history" class="short-history">Инфо: ${user.info}</div>
                                </div>`
                            }
                            if (user.tags) {
                            html_str += `<section class="interests">
                                <div id="tags">
                                    <p class="white">Интересы: </p>`;
                            for (let tag of user.tags)
                                html_str += `
                                            <div class="tag">
                                                <span>#${tag.tag}</span>
                                            </div>`;
                            }
                        html_str += `
                                    </div>
                                </section>
                            </section>
                            <section class="images">
                                <div class="img-area">
                                    <div>
                                        <img id="output" style="display: none;">
                                        <!-- <div class="hover-info">
                                            <div>Swap avatar</div>
                                        </div> -->
                                    </div>
                                </div>
                                <input type="file" id="imageInput" class="not-here-pls"name="imageInput" accept=".jpg, .jpeg, .png" onchange="image.loadFile(event)">
                                <label style="display: none;" for="imageInput" class="not-here-pls" id="image-input">
                                    <svg version="1.1" id="Capa_1" class="not-here-pls" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 477.863 477.863" style="enable-background:new 0 0 477.863 477.863;" xml:space="preserve"><g><g><path d="M409.598,153.596h-85.333c-9.426,0-17.067,7.641-17.067,17.067s7.641,17.067,17.067,17.067h85.333c9.426,0,17.067,7.641,17.067,17.067v221.867c0,9.426-7.641,17.067-17.067,17.067H68.265c-9.426,0-17.067-7.641-17.067-17.067V204.796c0-9.426,7.641-17.067,17.067-17.067h85.333c9.426,0,17.067-7.641,17.067-17.067s-7.641-17.067-17.067-17.067H68.265c-28.277,0-51.2,22.923-51.2,51.2v221.867c0,28.277,22.923,51.2,51.2,51.2h341.333c28.277,0,51.2-22.923,51.2-51.2V204.796C460.798,176.519,437.875,153.596,409.598,153.596z"/></g></g><g><g><path d="M336.331,90.33L250.998,4.997c-6.664-6.663-17.468-6.663-24.132,0L141.532,90.33c-6.548,6.78-6.36,17.584,0.42,24.132c6.614,6.388,17.099,6.388,23.713,0l56.201-56.201V341.33c0,9.426,7.641,17.067,17.067,17.067s17.067-7.641,17.067-17.067V58.262l56.201,56.201c6.78,6.548,17.584,6.36,24.132-0.42C342.719,107.429,342.719,96.944,336.331,90.33z"/></g></g></svg>
                                </label>
                            </section>`
                            {% if global_user.is_authenticated %}
                                html_str += `
                                    <section id="buttons-card">
                                        <button type="button" id="act-dislike-${i}" class="btn btn-outline-danger btn-lg"><i id="act-dislike" class="fa fa-thumbs-down"></i></button>
                                        <button type="button" id="act-like-${i}" class="btn btn-outline-success btn-lg"><i id="act-like" class="fa fa-thumbs-up"></i></button>
                                    </section> `
                                function appendToStack(_i, id) {
                                    stackCall.push(() => {initListeners(_i, id)});
                                }
                                appendToStack(i, user.id);
                                i -=- 1;
                            {% endif %}
                            html_str += '</section>';
                        }
                        html_str += '</div>';
                        $("div.center").append(html_str);
                        stackCall.forEach(cmd => {
                            cmd();
                        })

                }
            })
        });
    </script>
    <script src="{% static 'js/callAvitoApi.js' %}"></script>
    <script>
        function check_line_clamp() {
            document.querySelectorAll("#history").forEach(el => {
                if (el.scrollHeight === el.clientHeight) {
                    el.parentNode.querySelector("button").style.display = "none";
                } else {
                    el.parentNode.querySelector("button").style.display = "block";
                }
            })
        }
        check_line_clamp();
        window.onresize = function(e) {
            check_line_clamp();
        }
    </script>
    <script>
        document.querySelectorAll(".user-profile-short").forEach(el => {
            connect = el.querySelector("#connection .connect-date");
            _date = connect.textContent;
            if (_date !== "online" && _date !== "offline") {
                _date = moment(_date, "MMDDYYYY hh:mm:ss").fromNow();
                _date = _date === "Invalid date" ? "offline" : _date;
                connect.textContent = _date;
            }
        });
    </script>
    <script>
        function check_line_clamp() {
            document.querySelectorAll("#history").forEach(el => {
                if (el.scrollHeight === el.clientHeight) {
                    el.parentNode.querySelector("button").style.display = "none";
                } else {
                    el.parentNode.querySelector("button").style.display = "block";
                }
            })
        }
        check_line_clamp();
        window.onresize = function(e) {
            check_line_clamp();
        }
    </script>
    {% if global_user.id %}
    <script>
        csrftoken = getCookie('csrftoken');
        function initListeners(i, id) {
            document.getElementById("act-like-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_connects/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": id,
                            "type": 'плюс'
                        })
                    });
                }
            });
            document.getElementById("act-dislike-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_connects/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": id,
                            "type": 'минус'
                        })
                    });
                }
            });
            document.getElementById("btn-report-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_fakes/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": id
                        })
                    });
                }
            });
            document.getElementById("btn-block-" + i).addEventListener("click", function (e) {
                if (user_ids[i] !== {{ global_user.id }}) {
                    $.ajax({
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        url: "/api/v1/user_blacklists/",
                        type: "POST",
                        data: JSON.stringify({
                            "user_1_id": {{ global_user.id }},
                            "user_2_id": id
                        })
                    });
                }
            });
        }
    </script>
    {% endif %}
{% endblock %}
