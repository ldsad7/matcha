{% extends "base.html" %}

{% block title %}Чат{% endblock %}

{% block content %}
    {{ block.super }}
    <style>
        .data-message {
            color: #e2e2e2;
        }
        .block-message {
            margin-top: 7px;
            border: 2px #e2e2e2 solid;
            width: 100%;
            padding: 4px;
        }
        .from {
            color: #a1a1a1;
            font-size: 8px;
        }
        p {
            margin-bottom: 0;
        }
    </style>
    <section id="chat-room">
        <div style="width: 100%; display: flex; justify-content: center;">
            <section id="messages">
                <div class="message">
                    <p class="data-message"></p>
                </div>
                {% for message in messages %}
                    <div class="block-message {% if global_user.id == message.user_1.id %}{% if message.type == '1 -> 2' %}aqua-border{% endif %}{% else %}{% if message.type != '1 -> 2' %}aqua-border{% endif %}{% endif %}">
                        <p class="from">
                            {% if global_user.id == message.user_1.id %}
                                {% if message.type == "1 -> 2" %}
                                    you
                                {% else %}
                                    {{ message.user_2.username }}
                                {% endif %}
                            {% else %}
                                {% if message.type == "1 -> 2" %}
                                    {{ message.user_1.username }}
                                {% else %}
                                    you
                                {% endif %}
                            {% endif %}:
                        </p>
                        <p class="data-message">{{ message.message }}</p>
                    </div>
                {% endfor %}
            </section>
            <section class="messageInput">
                <div style="width: 100%; display: flex; align-items: center; justify-content: center;">
                    <label for="inp" class="inp">
                        <input type="text" id="chat-message-input" placeholder="&nbsp;">
                        <span class="label">input here</span>
                        <span class="focus-bg"></span>
                      </label>
                    <input id="chat-message-submit" type="button" value="Send">
                </div>
            </section>
        </div>
    </section>
    {{ room_name|json_script:"room-name" }}
{% endblock %}

{% block body_scripts %}
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        window.scrollTo(0,document.body.scrollHeight);
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        const userId = {{ global_user.id }};
        messageFromId = 1;

        function createBlockMessage(from) {
            let newBlockMessage = document.createElement("div");

            if (from !== "you:") {newBlockMessage.classList.add("aqua-border")}
            newBlockMessage.innerHTML = `<p class="from">${from}</p>`
            newBlockMessage.classList.add("block-message");
            return newBlockMessage;
        }

        chatSocket.onmessage = function(e) {
            const res = JSON.parse(e.data);
            const { message, sender_id } = res;
            if (!message)
                return;
            console.log(res);
            console.log(sender_id);
            messageFromId = sender_id;
            const messagesArea = document.getElementById("messages");
            let newMessage = document.createElement("p");
            const blocksMessages = document.querySelectorAll(".block-message");
            const lastMessageBlock = [...blocksMessages][blocksMessages.length - 1];
            let isLastMessageFromEnemy = false;

            if (lastMessageBlock) {
                isLastMessageFromEnemy = lastMessageBlock.querySelector(".from").innerText == "you :" ? false : true;
            }
            newMessage.classList.add("data-message");
            newMessage.innerHTML = message;
            if ((isLastMessageFromEnemy || !(lastMessageBlock)) && messageFromId == userId) {
                let newBlockMessage = createBlockMessage("you :");

                newBlockMessage.appendChild(newMessage);
                messagesArea.appendChild(newBlockMessage);
            } else if (messageFromId == userId) {
                lastMessageBlock.appendChild(newMessage);
            } else {
                if (lastMessageBlock && isLastMessageFromEnemy) {
                    lastMessageBlock.appendChild(newMessage);
                } else {
                    let newBlockMessage = createBlockMessage("{{ interlocutor }} :");

                    newBlockMessage.appendChild(newMessage);
                    messagesArea.appendChild(newBlockMessage);
                }
            }
            window.scrollTo(0,document.body.scrollHeight);
        };

        // chatSocket.onclose = function(e) {
        //     console.error('Chat socket closed unexpectedly');
        // };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            if (message) {
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'global_user_id': {{ global_user.id }}
                }));
                messageInputDom.value = '';
            }
        };
    </script>

{% endblock %}
