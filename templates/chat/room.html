{% extends "base.html" %}

{% load static %}

{% block title %}Чат{% endblock %}

{% block content %}
    {{ block.super }}
    <style>
        .data-message {
            color: #e2e2e2;
        }
        .block-message {
            margin-top: 7px;
            border: 2px #e2e2e2 solid;
            width: 100%;
            padding: 4px;
        }
        .from {
            color: #a1a1a1;
            font-size: 8px;
        }
        p {
            margin-bottom: 0;
        }
    </style>
    <section id="chat-room">
        <a href="/profiles/{{ interlocutor.id }}" class="chat-user-info">
            <div style="display: flex; align-items: center;">
                {% if interlocutor.photos %}
                    <img src="{{ interlocutor.photos.0.image }}" class="avatar"  alt="default profile picture">
                {% else %}
                    <img src="{% static 'img/default.png' %}" class="avatar" alt="default profile picture">
                {% endif %}
                <div style="display: flex; width: 80%;  justify-content: center;" >
                    <span class="username">{{ interlocutor.username }}</span>
                </div>
            </div>
        </a>

        <div class="messages-section-parent">
            <section id="messages">
                <div class="message">
                    <p class="data-message"></p>
                </div>
            </section>
            <section class="messageInput">
                <div style="width: 100%; display: flex; align-items: center; justify-content: center;">
                    <label for="inp" class="inp">
                        <input type="text" id="chat-message-input" placeholder="&nbsp;">
                        <span class="label">input here</span>
                        <span class="focus-bg"></span>
                      </label>
                    <input id="chat-message-submit" type="button" value="Send">
                </div>
            </section>
        </div>
    </section>
    {{ room_name|json_script:"room-name" }}
{% endblock %}

{% block body_scripts %}
    <script>
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        window.scrollTo(0,document.body.scrollHeight);
        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chat/'
            + roomName
            + '/'
        );

        const getCurrentMonthName = () => {
            return ["января", "февраля", "марта", "апреля", "мая", "июня",
                "июля", "августа", "сентября", "октября", "ноября", "декабря"
                ][new Date().getMonth()];
        }

        const userId = {{ global_user.id }};
        messageFromId = 1;

        function createBlockMessage({from, created}) {
            let newBlockMessage = document.createElement("div");

            if (from !== "you :") {newBlockMessage.classList.add("aqua-border")}
            newBlockMessage.innerHTML = `<p class="from">${from}</p>`
            newBlockMessage.classList.add("block-message");
            return newBlockMessage;
        }

        function createBlockDate({day, month}) {
            let newBlockMessage = document.createElement("div");

            newBlockMessage.classList.add("date-block");
            newBlockMessage.innerHTML = `<span class="day">${day}</span> ${month}`

            return newBlockMessage;
        }

        let newMes = {};
        const messages = [];

        Date.prototype.timeNow = function () {
            return ((this.getHours() < 10)?"0":"") + this.getHours() +":"+ ((this.getMinutes() < 10)?"0":"") + this.getMinutes() +":"+ ((this.getSeconds() < 10)?"0":"") + this.getSeconds();
        }

        {% for message in messages %}
            {% if message.message %}
                newMes = {};
                newMes.sender_id = {% if global_user.id == message.user_1.id %}
                                    {% if message.type == "1 -> 2" %}
                                        {{ global_user.id }}
                                    {% else %}
                                        {{ message.user_2.id }}
                                    {% endif %}
                                {% else %}
                                    {% if message.type == "1 -> 2" %}
                                        {{ message.user_1.id }}
                                    {% else %}
                                        {{ global_user.id }}
                                    {% endif %}
                                {% endif %};
                newMes.message = "{{ message.message }}";
                newMes.created = {};
                newMes.created.day = "{{ message.created|date:'d' }}";
                newMes.created.month = "{{ message.created }}".split(" ")[1];
                newMes.created.time = "{{ message.created|date:'h:i:s' }}";
                messages.push(newMes);
            {% endif %}
        {% endfor %}

        function appendMessage(e) {
            const { message, sender_id } = e;
            let { created } = e;
            if (!created) {
                created = {};
                created.day = new Date().getDate();
                created.month = getCurrentMonthName();
                created.time = new Date().timeNow();
            }
            if (!created.month) {
                created.month = getCurrentMonthName();
            }
            if (!message)
                return;
            messageFromId = sender_id;
            const messagesArea = document.getElementById("messages");
            let newMessage = document.createElement("p");
            const blocksDate = document.querySelectorAll(".date-block .day");
            const lastDate = [...blocksDate][blocksDate.length - 1];
            const blocksMessages = document.querySelectorAll(".block-message");
            const lastMessageBlock = [...blocksMessages][blocksMessages.length - 1];
            let isLastMessageFromEnemy = false;

            if (lastMessageBlock) {
                isLastMessageFromEnemy = lastMessageBlock.querySelector(".from").innerText == "you :" ? false : true;
            }
            if (!lastDate) {
                if (created) {
                    messagesArea.appendChild(createBlockDate({day: created.day, month: created.month}));
                }
                else {
                    messagesArea.appendChild(createBlockDate({day: new Date().getDate(), month: getCurrentMonthName()}));
                }
            } else if (lastDate.textContent != created.day) {
                if (created) {
                    messagesArea.appendChild(createBlockDate({day: created.day, month: created.month}));
                }
                else {
                    messagesArea.appendChild(createBlockDate({day: new Date().getDate(), month: getCurrentMonthName()}));
                }
            }
            newMessage.classList.add("data-message");
            newMessage.innerHTML = `<span>${message}</span><span class="message-date">${created.time}</span>`;
            if ((isLastMessageFromEnemy || !(lastMessageBlock)) && messageFromId == userId) {
                let newBlockMessage = createBlockMessage({from: "you :", created: created});

                newBlockMessage.appendChild(newMessage);
                messagesArea.appendChild(newBlockMessage);
            } else if (messageFromId == userId) {
                lastMessageBlock.appendChild(newMessage);
            } else {
                if (lastMessageBlock && isLastMessageFromEnemy) {
                    lastMessageBlock.appendChild(newMessage);
                } else {
                    let newBlockMessage = createBlockMessage({from: "{{ interlocutor.username }} :", created: created});

                    newBlockMessage.appendChild(newMessage);
                    messagesArea.appendChild(newBlockMessage);
                }
            }
            window.scrollTo(0,document.body.scrollHeight);
        }

        messages.forEach(mes => {
            appendMessage(mes);
        })

        chatSocket.onmessage = (e) => {appendMessage(JSON.parse(e.data))};

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            if (message) {
                chatSocket.send(JSON.stringify({
                    'message': message,
                    'global_user_id': {{ global_user.id }}
                }));
                messageInputDom.value = '';
            }
        };
    </script>
    <script src="{% static 'js/toggleBtn.js' %}"></script>

{% endblock %}
